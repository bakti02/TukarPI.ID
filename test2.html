<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kripto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    
    /* Layout Utama */
    .dashboard-container {
      display: grid;
      grid-template-columns: 1fr 350px;
      height: 100vh;
    }
    
    /* Responsive Breakpoint */
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 100%;
        grid-template-rows: 60vh 40vh;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="dashboard-container">
    <!-- TradingView Chart -->
    <div class="bg-white border-r border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-200 sticky top-0 z-10 bg-white">
        <div class="flex justify-between items-center">
          <div>
            <h1 id="current-coin" class="text-xl font-bold">Pilih Koin</h1>
            <div class="flex items-center mt-1">
              <span id="current-price" class="text-2xl font-bold">-</span>
              <span id="price-change" class="ml-2 px-2 py-1 rounded-full text-sm"></span>
            </div>
          </div>
          <div class="flex space-x-1" id="timeframes">
            <button class="timeframe-btn px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded" data-tf="15">15m</button>
            <button class="timeframe-btn px-2 py-1 text-xs hover:bg-gray-100 rounded" data-tf="60">1H</button>
            <button class="timeframe-btn px-2 py-1 text-xs hover:bg-gray-100 rounded" data-tf="240">4H</button>
            <button class="timeframe-btn px-2 py-1 text-xs hover:bg-gray-100 rounded" data-tf="1D">1D</button>
          </div>
        </div>
      </div>
      
      <div class="flex-1 relative">
        <div id="tradingview-chart" class="absolute inset-0"></div>
        <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-white">
          <div>
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p>Memuat chart...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Daftar Koin -->
    <div class="bg-white flex flex-col">
      <div class="p-4 border-b border-gray-200 sticky top-0 z-10 bg-white">
        <h2 class="text-xl font-bold mb-3">Daftar Koin</h2>
        <div class="relative">
          <input 
            type="text" 
            placeholder="Cari koin..." 
            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
            id="coin-search"
          >
          <svg class="absolute right-3 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto" id="coin-list">
        <div class="p-4 space-y-3">
          <div class="h-16 bg-gray-200 rounded animate-pulse"></div>
          <div class="h-16 bg-gray-200 rounded animate-pulse"></div>
          <div class="h-16 bg-gray-200 rounded animate-pulse"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TradingView Script -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  
  <script>
    // 1. Config
    const COINS_TO_LOAD = 20;
    let currentCoin = null;
    let tvWidget = null;
    let allCoins = [];

    // 2. Main Function
    async function init() {
      await loadCoinData();
      setupEventListeners();
      
      // Default select Bitcoin
      const btc = allCoins.find(c => c.symbol === 'btc');
      if (btc) {
        selectCoin(btc);
      }
    }

    // 3. Load Coin Data
    async function loadCoinData() {
      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${COINS_TO_LOAD}&page=1&sparkline=false&price_change_percentage=24h`
        );
        
        if (!response.ok) throw new Error("Gagal memuat data");
        
        const coins = await response.json();
        allCoins = coins.map(coin => ({
          id: coin.id,
          symbol: coin.symbol,
          name: coin.name,
          image: coin.image,
          price: coin.current_price,
          change24h: coin.price_change_percentage_24h
        }));
        
        renderCoinList(allCoins);
      } catch (error) {
        console.error("Error:", error);
        document.getElementById('coin-list').innerHTML = `
          <div class="p-4 text-red-500">
            Gagal memuat data: ${error.message}
            <button onclick="loadCoinData()" class="mt-2 text-blue-500">Coba lagi</button>
          </div>
        `;
      }
    }

    // 4. Render Coin List
    function renderCoinList(coins) {
      const container = document.getElementById('coin-list');
      container.innerHTML = '';
      
      coins.forEach(coin => {
        const isUp = coin.change24h >= 0;
        
        const coinElement = document.createElement('div');
        coinElement.className = `flex items-center p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50`;
        coinElement.innerHTML = `
          <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 rounded-full mr-3">
          <div class="flex-1">
            <div class="font-medium">${coin.name}</div>
            <div class="text-sm text-gray-500">${coin.symbol.toUpperCase()}</div>
          </div>
          <div class="text-right">
            <div class="font-medium">$${coin.price.toLocaleString()}</div>
            <div class="text-xs ${isUp ? 'text-green-500' : 'text-red-500'}">
              ${isUp ? '↑' : '↓'} ${Math.abs(coin.change24h).toFixed(1)}%
            </div>
          </div>
        `;
        
        coinElement.addEventListener('click', () => {
          selectCoin(coin);
        });
        
        container.appendChild(coinElement);
      });
    }

    // 5. Select Coin
    function selectCoin(coin) {
      currentCoin = coin;
      
      // Update UI
      document.getElementById('current-coin').textContent = coin.name;
      document.getElementById('current-price').textContent = `$${coin.price.toLocaleString()}`;
      
      const isUp = coin.change24h >= 0;
      const changeElement = document.getElementById('price-change');
      changeElement.textContent = `${isUp ? '↑' : '↓'} ${Math.abs(coin.change24h).toFixed(2)}%`;
      changeElement.className = `ml-2 px-2 py-1 rounded-full text-sm ${
        isUp ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
      
      // Load TradingView chart
      loadTradingViewChart();
    }

    // 6. Load TradingView Chart
    function loadTradingViewChart(timeframe = '15') {
      document.getElementById('chart-loading').style.display = 'flex';
      
      // Remove existing widget
      if (tvWidget !== null) {
        tvWidget.remove();
        tvWidget = null;
      }
      
      // Create new widget
      tvWidget = new TradingView.widget({
        autosize: true,
        symbol: `BINANCE:${currentCoin.symbol.toUpperCase()}USDT`,
        interval: timeframe,
        timezone: "Asia/Jakarta",
        theme: "light",
        style: "1",
        locale: "id",
        toolbar_bg: "#f1f3f6",
        enable_publishing: false,
        hide_side_toolbar: false,
        allow_symbol_change: false,
        container_id: "tradingview-chart",
        studies: [
          "RSI@tv-basicstudies",
          "Volume@tv-basicstudies"
        ],
        callback: () => {
          document.getElementById('chart-loading').style.display = 'none';
        }
      });
    }

    // 7. Setup Event Listeners
    function setupEventListeners() {
      // Timeframe buttons
      document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!currentCoin) return;
          
          document.querySelectorAll('.timeframe-btn').forEach(b => {
            b.classList.remove('bg-blue-100', 'text-blue-800');
            b.classList.add('hover:bg-gray-100');
          });
          
          btn.classList.add('bg-blue-100', 'text-blue-800');
          btn.classList.remove('hover:bg-gray-100');
          
          loadTradingViewChart(btn.dataset.tf);
        });
      });
      
      // Search functionality
      document.getElementById('coin-search').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allCoins.filter(coin => 
          coin.name.toLowerCase().includes(searchTerm) || 
          coin.symbol.toLowerCase().includes(searchTerm)
        );
        renderCoinList(filtered);
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
