<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kripto Responsif</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Layout Utama */
    .dashboard-container {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 380px;
      height: 100vh;
      max-width: 100vw;
      overflow: hidden;
    }
    
    /* Responsive Breakpoints */
    @media (max-width: 1024px) {
      .dashboard-container {
        grid-template-columns: minmax(0, 1fr) 320px;
      }
    }
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 100%;
        grid-template-rows: 55vh 45vh;
      }
    }
    
    /* Scrollbar Custom */
    .coin-list::-webkit-scrollbar {
      width: 6px;
    }
    .coin-list::-webkit-scrollbar-thumb {
      background: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    
    /* TradingView Container */
    .chart-container {
      min-width: 0; /* Penting untuk mencegah overflow */
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="dashboard-container">
    <!-- Chart Section (Kiri) -->
    <div class="chart-container bg-white border-r border-gray-200 flex flex-col">
      <!-- Chart Header -->
      <div class="p-3 border-b border-gray-200 sticky top-0 z-10 bg-white">
        <div class="flex justify-between items-center">
          <div class="min-w-0">
            <h1 id="current-coin" class="text-lg font-bold truncate">Pilih Koin</h1>
            <div class="flex items-center mt-1">
              <span id="current-price" class="text-xl font-bold truncate">-</span>
              <span id="price-change" class="ml-2 px-2 py-1 rounded-full text-xs whitespace-nowrap"></span>
            </div>
          </div>
          <div class="flex space-x-1" id="timeframes">
            <button class="timeframe-btn px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded" data-tf="15">15m</button>
            <button class="timeframe-btn px-2 py-1 text-xs hover:bg-gray-100 rounded" data-tf="60">1H</button>
            <button class="timeframe-btn px-2 py-1 text-xs hover:bg-gray-100 rounded" data-tf="240">4H</button>
            <button class="timeframe-btn px-2 py-1 text-xs hover:bg-gray-100 rounded" data-tf="1D">1D</button>
          </div>
        </div>
      </div>
      
      <!-- TradingView Widget -->
      <div class="flex-1 relative">
        <div id="tradingview-chart" class="absolute inset-0">
          <div class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-2"></div>
              <p class="text-gray-600">Memuat chart...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Coin List Section (Kanan) -->
    <div class="bg-white flex flex-col overflow-hidden">
      <!-- Coin List Header -->
      <div class="p-3 border-b border-gray-200 sticky top-0 z-10 bg-white">
        <h2 class="text-lg font-bold mb-2">ðŸ’° Daftar Koin</h2>
        <div class="relative">
          <input 
            type="text" 
            placeholder="Cari koin..." 
            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="coin-search"
          >
          <svg class="absolute right-3 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <!-- Coin List -->
      <div class="flex-1 overflow-y-auto coin-list" id="coin-list">
        <div class="p-3 space-y-2">
          <div class="h-14 bg-gray-200 rounded animate-pulse"></div>
          <div class="h-14 bg-gray-200 rounded animate-pulse"></div>
          <div class="h-14 bg-gray-200 rounded animate-pulse"></div>
          <div class="h-14 bg-gray-200 rounded animate-pulse"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TradingView Script -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  
  <script>
    // 1. App Configuration
    const CONFIG = {
      coinsToLoad: 20,
      defaultCoin: 'BTC',
      defaultTimeframe: '15'
    };

    // 2. Initialize App
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Load TradingView script
        await loadTradingViewScript();
        
        // Load coin data
        const coins = await loadCoinData();
        
        // Render coin list
        renderCoinList(coins);
        
        // Select default coin
        const defaultCoin = coins.find(c => c.symbol === CONFIG.defaultCoin.toLowerCase());
        if (defaultCoin) selectCoin(defaultCoin);
        
        // Setup event listeners
        setupEventListeners();
      } catch (error) {
        console.error("Initialization error:", error);
        document.getElementById('coin-list').innerHTML = `
          <div class="p-4 text-red-500 text-sm">
            Error: ${error.message}
            <button onclick="location.reload()" class="mt-2 text-blue-500">Refresh</button>
          </div>
        `;
      }
    });

    // 3. Core Functions
    async function loadTradingViewScript() {
      return new Promise((resolve, reject) => {
        if (window.TradingView) return resolve();
        
        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/tv.js';
        script.onload = resolve;
        script.onerror = () => reject(new Error('Gagal memuat TradingView'));
        document.head.appendChild(script);
      });
    }

    async function loadCoinData() {
      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${CONFIG.coinsToLoad}&page=1&sparkline=false&price_change_percentage=24h`
        );
        
        if (!response.ok) throw new Error('Gagal memuat data koin');
        
        return await response.json();
      } catch (error) {
        throw error;
      }
    }

    function renderCoinList(coins) {
      const container = document.getElementById('coin-list');
      container.innerHTML = '';
      
      coins.forEach(coin => {
        const isUp = coin.price_change_percentage_24h >= 0;
        
        const coinElement = document.createElement('div');
        coinElement.className = 'flex items-center p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50';
        coinElement.innerHTML = `
          <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 rounded-full mr-2">
          <div class="flex-1 min-w-0">
            <div class="font-medium truncate">${coin.name}</div>
            <div class="text-xs text-gray-500 truncate">${coin.symbol.toUpperCase()}</div>
          </div>
          <div class="text-right ml-2 whitespace-nowrap">
            <div class="font-medium">$${coin.current_price.toLocaleString()}</div>
            <div class="text-xs ${isUp ? 'text-green-500' : 'text-red-500'}">
              ${isUp ? 'â†‘' : 'â†“'} ${Math.abs(coin.price_change_percentage_24h).toFixed(1)}%
            </div>
          </div>
        `;
        
        coinElement.addEventListener('click', () => selectCoin(coin));
        container.appendChild(coinElement);
      });
    }

    function selectCoin(coin) {
      // Update UI
      document.getElementById('current-coin').textContent = coin.name;
      document.getElementById('current-price').textContent = `$${coin.current_price.toLocaleString()}`;
      
      const isUp = coin.price_change_percentage_24h >= 0;
      const changeElement = document.getElementById('price-change');
      changeElement.textContent = `${isUp ? 'â†‘' : 'â†“'} ${Math.abs(coin.price_change_percentage_24h).toFixed(2)}%`;
      changeElement.className = `ml-2 px-2 py-1 rounded-full text-xs ${
        isUp ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
      
      // Load TradingView chart
      loadTradingViewChart(coin.symbol);
    }

    function loadTradingViewChart(symbol, timeframe = CONFIG.defaultTimeframe) {
      if (!window.TradingView) {
        console.error('TradingView not loaded');
        return;
      }
      
      // Remove existing widget
      if (window.tvWidget) {
        window.tvWidget.remove();
        window.tvWidget = null;
      }
      
      // Create new widget
      try {
        window.tvWidget = new TradingView.widget({
          autosize: true,
          symbol: `BINANCE:${symbol.toUpperCase()}USDT`,
          interval: timeframe,
          timezone: "Asia/Jakarta",
          theme: "light",
          style: "1",
          locale: "id",
          toolbar_bg: "#f1f3f6",
          enable_publishing: false,
          hide_side_toolbar: false,
          allow_symbol_change: false,
          container_id: "tradingview-chart",
          studies: ["RSI@tv-basicstudies", "Volume@tv-basicstudies"]
        });
      } catch (error) {
        console.error('Error loading TradingView:', error);
        document.getElementById('tradingview-chart').innerHTML = `
          <div class="flex items-center justify-center h-full text-red-500 p-4">
            Gagal memuat chart. Coba pilih koin lain atau refresh halaman.
          </div>
        `;
      }
    }

    function setupEventListeners() {
      // Timeframe buttons
      document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          if (!window.currentCoin) return;
          
          document.querySelectorAll('.timeframe-btn').forEach(b => {
            b.classList.remove('bg-blue-100', 'text-blue-800');
            b.classList.add('hover:bg-gray-100');
          });
          
          this.classList.add('bg-blue-100', 'text-blue-800');
          this.classList.remove('hover:bg-gray-100');
          
          loadTradingViewChart(window.currentCoin.symbol, this.dataset.tf);
        });
      });
      
      // Search functionality
      document.getElementById('coin-search').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const coins = window.allCoins || [];
        const filtered = coins.filter(coin => 
          coin.name.toLowerCase().includes(searchTerm) || 
          coin.symbol.toLowerCase().includes(searchTerm)
        );
        renderCoinList(filtered);
      });
    }

    // Store references globally for debugging
    window.allCoins = [];
    window.currentCoin = null;
    window.tvWidget = null;
  </script>
</body>
</html>
