<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beli Kripto - Pembayaran</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .payment-method-logo {
      width: 60px;
      height: 30px;
      object-fit: contain;
      margin: 0 auto 10px;
      display: block;
    }
    .payment-details-logo {
      width: 80px;
      height: 40px;
      object-fit: contain;
      margin: 0 auto 15px;
      display: block;
    }
    .payment-logo {
      height: 24px;
      max-width: 80px;
      display: inline-block;
      vertical-align: middle;
    }
    .payment-method-logo-container {
      height: 30px;
      display: flex;
      align-items: center;
    }
    #confirm-wallet {
      font-family: monospace;
      word-break: break-all;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      max-width: 200px;
      text-align: right;
    }
    #payment-info .font-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .crypto-logo {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    .coin-received {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(90deg, #2563eb 0%, #4f46e5 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .loading-price {
      color: #6b7280;
      font-style: italic;
    }
    .animate-pulse {
      animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto p-4">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-2xl font-bold text-blue-600 mb-2">Beli Kripto</h1>
      <p class="text-gray-600">Isi form pembelian dan pilih metode pembayaran</p>
    </header>

    <!-- Purchase Form -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
      <form id="purchase-form">
        <!-- Pilihan Kripto -->
        <div class="mb-6">
          <label for="crypto" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kripto</label>
          <select id="crypto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <option value="" disabled selected>Memuat daftar koin...</option>
          </select>
        </div>

        <!-- Jumlah dalam Rupiah -->
        <div class="mb-6">
          <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pembelian (Rp)</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <span class="text-gray-500">Rp</span>
            </div>
            <input type="number" id="amount" 
                   class="block w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="100.000" min="10000">
          </div>
          <p class="text-xs text-gray-500 mt-1">Minimal pembelian Rp 10.000</p>
        </div>

        <!-- Info Harga Real-time -->
        <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
          <div class="flex justify-center mb-3">
            <img id="crypto-logo" src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" alt="Crypto Logo" class="w-12 h-12">
          </div>
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium text-blue-600">Harga Real-time</span>
            <span id="realtime-price" class="font-semibold text-blue-800 loading-price">Memuat harga...</span>
          </div>
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium text-blue-600">Biaya Layanan (5%)</span>
            <span id="fee-amount" class="font-medium text-red-500">- Rp 0</span>
          </div>
          <div class="pt-3 border-t border-blue-200">
            <p class="text-xs font-medium text-blue-500 mb-1">JUMLAH KOIN DITERIMA</p>
            <div class="flex justify-between items-center">
              <span class="text-sm text-blue-600">Estimasi yang akan Anda terima</span>
              <span id="coin-received" class="coin-received">0</span>
            </div>
          </div>
        </div>

        <!-- Alamat Wallet -->
        <div class="mb-6">
          <label for="wallet" class="block text-sm font-medium text-gray-700 mb-2">Alamat Wallet Anda</label>
          <input type="text" id="wallet" 
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                 placeholder="Contoh: bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq" required>
          <p class="text-xs text-gray-500 mt-1">Pastikan alamat wallet benar. Kripto akan dikirim ke alamat ini.</p>
        </div>

        <!-- Metode Pembayaran -->
        <div class="mb-6">
          <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
          <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            <option value="" disabled selected>Pilih metode pembayaran</option>
            <option value="bca">Bank BCA</option>
            <option value="dana">DANA</option>
            <option value="ovo">OVO</option>
            <option value="gopay">GOPAY</option>
          </select>
        </div>

        <button type="submit" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow">
          Lanjutkan Pembayaran
        </button>
      </form>
    </div>

    <!-- Payment Info -->
    <div id="payment-info" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
      <div class="text-center mb-4">
        <h2 class="text-xl font-bold text-blue-600">Selesaikan Pembayaran</h2>
        <p class="text-gray-600">Lakukan pembayaran sesuai instruksi berikut</p>
      </div>

      <!-- Detail Pesanan -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <div class="flex justify-between mb-2">
          <span class="text-gray-600">Kripto</span>
          <span id="confirm-crypto" class="font-medium">BTC</span>
        </div>
        <div class="flex justify-between mb-2">
          <span class="text-gray-600">Jumlah Pembelian</span>
          <span id="confirm-amount" class="font-medium">Rp 0</span>
        </div>
        <div class="flex justify-between mb-2">
          <span class="text-gray-600">Jumlah Koin</span>
          <span id="confirm-coin" class="coin-received">0</span>
        </div>
        <div class="flex justify-between mb-2 items-center">
          <span class="text-gray-600">Metode Pembayaran</span>
          <div id="confirm-method" class="payment-method-logo-container"></div>
        </div>
        <div class="flex justify-between mb-2 items-start">
          <span class="text-gray-600">Alamat Wallet</span>
          <span id="confirm-wallet" class="font-mono text-sm break-all text-right max-w-[200px]">-</span>
        </div>
        <div class="flex justify-between border-t border-gray-200 pt-2">
          <span class="font-medium">Total Pembayaran</span>
          <span id="confirm-total" class="font-bold text-blue-600">Rp 0</span>
        </div>
      </div>

      <!-- Info Pembayaran -->
      <div id="payment-details">
        <!-- BCA -->
        <div id="bca-details" class="hidden bg-blue-50 p-6 rounded-lg mb-4 text-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Bank_Central_Asia.svg" alt="BCA" class="payment-details-logo">
          <div class="mb-4">
            <div class="font-mono text-lg bg-white py-2 px-4 rounded">0332997201</div>
            <p class="text-sm text-gray-600 mt-2">a.n. Agus Mulia Bakti</p>
          </div>
          <button onclick="copyToClipboard('0332997201')" class="w-full max-w-xs mx-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center">
            <i class="fas fa-copy mr-2"></i> Salin Nomor Rekening
          </button>
        </div>

        <!-- DANA -->
        <div id="dana-details" class="hidden bg-blue-50 p-6 rounded-lg mb-4 text-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/DANA_logo.svg" alt="DANA" class="payment-details-logo">
          <div class="mb-4">
            <div class="font-mono text-lg bg-white py-2 px-4 rounded">087878787523</div>
            <p class="text-sm text-gray-600 mt-2">a.n. Agus Mulia Bakti</p>
          </div>
          <button onclick="copyToClipboard('087878787523')" class="w-full max-w-xs mx-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center">
            <i class="fas fa-copy mr-2"></i> Salin Nomor
          </button>
        </div>

        <!-- OVO -->
        <div id="ovo-details" class="hidden bg-blue-50 p-6 rounded-lg mb-4 text-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/e/eb/OVO_logo_2019.svg" alt="OVO" class="payment-details-logo">
          <div class="mb-4">
            <div class="font-mono text-lg bg-white py-2 px-4 rounded">087878787523</div>
            <p class="text-sm text-gray-600 mt-2">a.n. Agus Mulia Bakti</p>
          </div>
          <button onclick="copyToClipboard('087878787523')" class="w-full max-w-xs mx-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center">
            <i class="fas fa-copy mr-2"></i> Salin Nomor
          </button>
        </div>

        <!-- GOPAY -->
        <div id="gopay-details" class="hidden bg-blue-50 p-6 rounded-lg mb-4 text-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Gopay_logo.svg" alt="GOPAY" class="payment-details-logo">
          <div class="mb-4">
            <div class="font-mono text-lg bg-white py-2 px-4 rounded">087878787523</div>
            <p class="text-sm text-gray-600 mt-2">a.n. Agus Mulia Bakti</p>
          </div>
          <button onclick="copyToClipboard('087878787523')" class="w-full max-w-xs mx-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center">
            <i class="fas fa-copy mr-2"></i> Salin Nomor
          </button>
        </div>
      </div>

      <div class="text-center">
        <button onclick="confirmPayment()" class="w-full py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg shadow">
          Saya Sudah Bayar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Data koin default jika API tidak tersedia
    const defaultCryptoData = {
      'BTC': { name: 'Bitcoin', price: 520000000, image: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png' },
      'ETH': { name: 'Ethereum', price: 32000000, image: 'https://cryptologos.cc/logos/ethereum-eth-logo.png' },
      'USDT': { name: 'Tether', price: 15500, image: 'https://cryptologos.cc/logos/tether-usdt-logo.png' },
      'BNB': { name: 'BNB', price: 5000000, image: 'https://cryptologos.cc/logos/bnb-bnb-logo.png' },
      'SOL': { name: 'Solana', price: 1500000, image: 'https://cryptologos.cc/logos/solana-sol-logo.png' },
      'XRP': { name: 'XRP', price: 8000, image: 'https://cryptologos.cc/logos/xrp-xrp-logo.png' },
      'ADA': { name: 'Cardano', price: 5000, image: 'https://cryptologos.cc/logos/cardano-ada-logo.png' },
      'DOGE': { name: 'Dogecoin', price: 1000, image: 'https://cryptologos.cc/logos/dogecoin-doge-logo.png' },
      'DOT': { name: 'Polkadot', price: 70000, image: 'https://cryptologos.cc/logos/polkadot-new-dot-logo.png' },
      'SHIB': { name: 'Shiba Inu', price: 0.0002, image: 'https://cryptologos.cc/logos/shiba-inu-shib-logo.png' }
    };

    // Variabel global
    let cryptoData = {};
    let exchangeRate = 15000; // Default exchange rate USD to IDR

    // Fungsi mengambil data dari CoinGecko API
    async function fetchCryptoData() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false');
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        const data = await response.json();
        console.log('Data from CoinGecko:', data);
        
        // Format data
        const formattedData = {};
        data.forEach(coin => {
          formattedData[coin.symbol.toUpperCase()] = {
            name: coin.name,
            price: coin.current_price,
            image: coin.image
          };
        });
        
        return formattedData;
      } catch (error) {
        console.error('Error fetching CoinGecko data:', error);
        console.log('Using default crypto data');
        return defaultCryptoData;
      }
    }

    // Fungsi mengambil kurs USD ke IDR
    async function fetchExchangeRate() {
      try {
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const data = await response.json();
        return data.rates.IDR || 15000;
      } catch (error) {
        console.error('Error fetching exchange rate:', error);
        return 15000;
      }
    }

    // Fungsi mengisi dropdown koin
    async function populateCryptoDropdown() {
      const cryptoSelect = document.getElementById('crypto');
      
      try {
        // Clear existing options
        cryptoSelect.innerHTML = '';
        
        // Add default option
        const defaultOption = new Option('Pilih kripto...', '');
        defaultOption.disabled = true;
        defaultOption.selected = true;
        cryptoSelect.add(defaultOption);
        
        // Add crypto options
        for (const [symbol, data] of Object.entries(cryptoData)) {
          const option = new Option(`${data.name} (${symbol})`, symbol);
          option.dataset.image = data.image;
          cryptoSelect.add(option);
          console.log(`Added option: ${symbol}`);
        }
        
        // Enable select
        cryptoSelect.disabled = false;
      } catch (error) {
        console.error('Error populating dropdown:', error);
        cryptoSelect.innerHTML = '<option value="" disabled selected>Gagal memuat data koin</option>';
      }
    }

    // Fungsi update tampilan harga
    function updatePriceDisplay(symbol) {
      const crypto = cryptoData[symbol];
      if (!crypto) return;
      
      const priceElement = document.getElementById('realtime-price');
      const logoElement = document.getElementById('crypto-logo');
      
      // Update logo
      logoElement.src = crypto.image;
      logoElement.alt = crypto.name;
      
      // Update harga dalam IDR
      const priceIDR = crypto.price * exchangeRate;
      priceElement.textContent = `Rp ${priceIDR.toLocaleString('id-ID')}`;
      priceElement.classList.remove('loading-price');
      
      // Update perhitungan
      updateCalculation();
    }

    // Fungsi update perhitungan
    function updateCalculation() {
      const symbol = document.getElementById('crypto').value;
      const amount = parseFloat(document.getElementById('amount').value) || 0;
      const crypto = cryptoData[symbol];
      
      if (!symbol || !crypto) {
        document.getElementById('coin-received').textContent = '0';
        document.getElementById('fee-amount').textContent = '- Rp 0';
        return;
      }
      
      const fee = amount * 0.05; // 5% biaya
      const netAmount = amount - fee;
      const coinsReceived = netAmount / (crypto.price * exchangeRate);
      
      document.getElementById('fee-amount').textContent = `- Rp ${fee.toLocaleString('id-ID')}`;
      document.getElementById('coin-received').textContent = coinsReceived.toFixed(8);
    }

    // Fungsi untuk mengirim konfirmasi WhatsApp
    function sendWhatsAppConfirmation() {
      const crypto = document.getElementById('confirm-crypto').textContent;
      const amount = document.getElementById('confirm-amount').textContent;
      const coin = document.getElementById('confirm-coin').textContent;
      const method = document.getElementById('confirm-method').innerHTML;
      const total = document.getElementById('confirm-total').textContent;
      const wallet = document.getElementById('confirm-wallet').textContent;
      
      // Buat teks metode pembayaran tanpa tag HTML
      const methodText = method.replace(/<[^>]*>/g, '').trim();
      
      // Format pesan WhatsApp seperti invoice
      const message = `📋 *INVOICE PEMBELIAN KRIPTO*\n\n` +
                     `================================\n` +
                     `🔹 *Jenis Kripto:* ${crypto}\n` +
                     `🔹 *Jumlah Pembelian:* ${amount}\n` +
                     `🔹 *Jumlah Koin:* ${coin}\n` +
                     `🔹 *Metode Pembayaran:* ${methodText}\n` +
                     `🔹 *Total Pembayaran:* ${total}\n` +
                     `================================\n` +
                     `📌 *Alamat Wallet Tujuan:*\n${wallet}\n\n` +
                     `💬 *Konfirmasi Pembayaran:*\n` +
                     `Saya telah melakukan transfer pembayaran sesuai nominal di atas.\n` +
                     `Berikut bukti transfer yang telah dilakukan:\n` +
                     `[Lampirkan screenshot bukti transfer]`;
      
      // Encode message untuk URL
      const encodedMessage = encodeURIComponent(message);
      
      // Buka WhatsApp dengan nomor admin yang benar
      window.open(`https://wa.me/6282147510780?text=${encodedMessage}`, '_blank');
    }

    // Copy to clipboard function
    function copyToClipboard(text) {
      // Buat textarea sementara
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        alert('Berhasil disalin ke clipboard: ' + text);
      } catch (err) {
        console.error('Gagal menyalin:', err);
        alert('Gagal menyalin ke clipboard');
      } finally {
        document.body.removeChild(textarea);
      }
    }

    // Confirm payment button
    function confirmPayment() {
      const confirmation = confirm("Pembayaran Anda telah direkam. Lakukan konfirmasi melalui WhatsApp dengan menekan tombol Ok dan Lanjut Konfirmasi dengan melampirkan bukti pembayaran.");
      
      if (confirmation) {
        // Ubah tombol
        const confirmBtn = document.querySelector('#payment-info button[onclick="confirmPayment()"]');
        confirmBtn.innerHTML = '<i class="fab fa-whatsapp mr-2"></i> Lanjut Konfirmasi';
        confirmBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        confirmBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        
        // Hapus onclick dan tambahkan event listener baru
        confirmBtn.removeAttribute('onclick');
        confirmBtn.addEventListener('click', sendWhatsAppConfirmation);
      }
    }

    // Get payment method name with logo ONLY (no text)
    function getPaymentMethodName(method) {
      const methods = {
        'bca': '<img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Bank_Central_Asia.svg" class="payment-logo" alt="BCA">',
        'dana': '<img src="https://upload.wikimedia.org/wikipedia/commons/7/72/DANA_logo.svg" class="payment-logo" alt="DANA">',
        'ovo': '<img src="https://upload.wikimedia.org/wikipedia/commons/e/eb/OVO_logo_2019.svg" class="payment-logo" alt="OVO">',
        'gopay': '<img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Gopay_logo.svg" class="payment-logo" alt="GOPAY">'
      };
      return methods[method] || method;
    }

    // Form submission
    document.getElementById('purchase-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validate form
      const amount = document.getElementById('amount').value;
      const wallet = document.getElementById('wallet').value;
      const paymentMethod = document.getElementById('payment-method').value;
      
      if (!amount || amount < 10000) {
        alert('Minimal pembelian Rp 10.000');
        return;
      }
      
      if (!wallet) {
        alert('Masukkan alamat wallet Anda');
        return;
      }
      
      if (!paymentMethod) {
        alert('Pilih metode pembayaran');
        return;
      }
      
      // Set confirmation values
      const crypto = document.getElementById('crypto').value;
      const coinReceived = document.getElementById('coin-received').textContent;
      const walletAddress = document.getElementById('wallet').value;
      
      document.getElementById('confirm-crypto').textContent = crypto;
      document.getElementById('confirm-amount').textContent = `Rp ${parseFloat(amount).toLocaleString('id-ID')}`;
      document.getElementById('confirm-coin').textContent = coinReceived;
      document.getElementById('confirm-method').innerHTML = getPaymentMethodName(paymentMethod);
      document.getElementById('confirm-total').textContent = `Rp ${parseFloat(amount).toLocaleString('id-ID')}`;
      document.getElementById('confirm-wallet').textContent = walletAddress;
      
      // Show corresponding payment details
      document.querySelectorAll('#payment-details > div').forEach(div => {
        div.classList.add('hidden');
      });
      document.getElementById(`${paymentMethod}-details`).classList.remove('hidden');
      
      // Show payment info
      document.getElementById('purchase-form').classList.add('hidden');
      document.getElementById('payment-info').classList.remove('hidden');
    });

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('Initializing...');
        
        // Load data
        [cryptoData, exchangeRate] = await Promise.all([
          fetchCryptoData(),
          fetchExchangeRate()
        ]);
        
        console.log('Crypto data loaded:', cryptoData);
        
        // Populate dropdown
        await populateCryptoDropdown();
        
        // Setup event listeners
        document.getElementById('crypto').addEventListener('change', function() {
          updatePriceDisplay(this.value);
        });
        
        document.getElementById('amount').addEventListener('input', updateCalculation);
        
        // Auto-update setiap 5 menit
        setInterval(async () => {
          cryptoData = await fetchCryptoData();
          exchangeRate = await fetchExchangeRate();
          const currentSymbol = document.getElementById('crypto').value;
          if (currentSymbol) updatePriceDisplay(currentSymbol);
        }, 300000); // 5 menit
        
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('crypto').innerHTML = 
          '<option value="" disabled selected>Gagal memuat daftar koin</option>';
      }
    });
  </script>
</body>
</html>
